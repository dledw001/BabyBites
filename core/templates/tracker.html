{% extends 'base.html' %}
{% load static %}

{% block title %}Food Tracker{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="bb-title mb-0 text-center py-2">
    <span class="top">FOOD TRACKER</span>
    </h1>

    {% if active_profile %}
        <script>
            window.BABY_ALLERGIES = {{ baby_allergies|safe }}
            console.log("BABY_ALLERGIES from template:", window.BABY_ALLERGIES);
        </script>
    {% else %}
        <script>
            window.BABY_ALLERGIES = [];
            console.log("BABY_ALLERGIES from template: (none)", window.BABY_ALLERGIES);
        </script>
    {% endif %}

<div class="content-center">
    {% if active_profile %}
    <div class="text-center my-3">
        <div style="display:inline-block; background-color:#76E2EA; color:#000;
                    padding:8px 16px; border-radius:10px; font-weight:600;
                    box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            {{ active_profile.name }}
            <br>
            <!--- This section is commented out to preserve troubleshooting allergy checks-->
            <!--
            <span class="small">
                Allergies:
                {% for a in active_profile.allergies.all %}
                    {{ a.name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    none
                {% endfor %}
            </span>
            -->
        </div>
    </div>

{% else %}
<div class="text-center my-3">
    <div style="display:inline-block; background-color:#76E2EA; color:#000;
                padding:8px 16px; border-radius:10px; font-weight:600;
                box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        No active baby selected
    </div>
  </div>
{% endif %}

    <!-- Form for adding food entries -->
    <div class="row justify-content-center">
        <div class="col-14 col-sm-12 col-md-10 col-lg-8">
            <form method="post">
                {% csrf_token %}


                <!-- Food entry form -->
                <div class="card mb-3">
                    <div class="card-header">
                        Food Entry
                    </div>
                    <div class="card-body">

                    <div id="allergen-alert" class="alert alert-danger d-none" role="alert"></div>

                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">{{ entry_form.food.label }}</label>
                        <div class="col-sm-9 d-flex align-items-center gap-2">
                            
                            {{ entry_form.food }}

                            <a href="{% url 'catalog' %}" class="btn btn-success" style="white-space: nowrap; height: 100%;"> 
                                + Add Food
                            </a>

                            {% if entry_form.food.errors %}
                                <div class="text-danger small">{{ entry_form.food.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Portion Size + Unit (side-by-side) -->
                    <div class="mb-3 row align-items-center">
                        <label class="col-sm-3 col-form-label">Portion size</label>
                        <div class="col-sm-5">
                        {{ entry_form.portion_size }}
                        {% if entry_form.portion_size.errors %} <div class="text-danger small">{{ entry_form.portion_size.errors }}</div> {% endif %}
                        </div>
                        <div class="col-sm-4">
                        {{ entry_form.portion_unit }}
                        {% if entry_form.portion_unit.errors %} <div class="text-danger small">{{ entry_form.portion_unit.errors }}</div> {% endif %}
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">Reaction</label>
                        <div class="col-sm-9">
                            {{ entry_form.reaction }}  {# hidden input #}

                            <div id="reaction-buttons" class="btn-group" role="group" aria-label="Reaction">
                                <button type="button" class="btn btn-outline-secondary bb-reaction-btn" data-value="love">‚ù§Ô∏è</button>
                                <button type="button" class="btn btn-outline-secondary bb-reaction-btn" data-value="happy">üòÑ</button>
                                <button type="button" class="btn btn-outline-secondary bb-reaction-btn" data-value="neutral">üòê</button>
                                <button type="button" class="btn btn-outline-secondary bb-reaction-btn" data-value="sad">‚òπÔ∏è</button>
                                <button type="button" class="btn btn-outline-secondary bb-reaction-btn" data-value="gross">ü§¢</button>
                            </div>

                            {% if entry_form.reaction.errors %}
                                <div class="text-danger small">{{ entry_form.reaction.errors }}</div>
                            {% endif %}
                            <div class="form-text">How did {{ active_profile.name }} react to this food?</div>
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label">{{ entry_form.notes.label }}</label>
                        <div class="col-sm-9">
                        {{ entry_form.notes }}
                        {% if entry_form.notes.errors %} <div class="text-danger small">{{ entry_form.notes.errors }}</div> {% endif %}
                        </div>
                    </div>
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-success">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Display recent food entries -->
    {% if food_entries %}
        <div class="row justify-content-center mt-5 mb-5 pb-5">
            <div class="col-12 col-md-10">
                <h3 class="mb-4 text-center">Your Recent Food Entries</h3>

                {% regroup food_entries by baby as baby_groups %}

                {% for group in baby_groups %}
                    <div class="card bg-warning-subtle mb-4 rounded-3 shadow-sm">
                        <div class="card-header fw-bold">
                            {{ group.grouper.name }}
                        </div>
                        <div class="card-body p-0">
                            <table class="table mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Food</th>
                                        <th>Portion</th>
                                        <th>Reaction</th>
                                        <th>Notes</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in group.list %}
                                        <tr>
                                            <tr>
                                                <td>{{ entry.food.name }}</td>
                                                <td>{{ entry.portion_size }} {{ entry.portion_unit }}</td>
                                                <td>
                                                    {% if entry.reaction == 'love' %}‚ù§Ô∏è
                                                    {% elif entry.reaction == 'happy' %}üòÑ
                                                    {% elif entry.reaction == 'neutral' %}üòê
                                                    {% elif entry.reaction == 'sad' %}‚òπÔ∏è
                                                    {% elif entry.reaction == 'gross' %}ü§¢
                                                    {% else %} -
                                                    {% endif %}
                                                </td>
                                                <td>{% if entry.notes %}{{ entry.notes }}{% else %}-{% endif %}</td>
                                                <td>{{ entry.date|date:"M. j, Y" }}</td>
                                            </tr>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
</div>

<!-- Allergen alert handling -->
<script>
(function() {
    var alertBox = document.getElementById('allergen-alert');
    var foodSelect = document.getElementById('{{ entry_form.food.id_for_label }}');
    var allergenMapUrl = "{% static 'core/data/allergens_map.json' %}";
    var babyAllergies = (window.BABY_ALLERGIES || []).map(function(s) {
        return s.toLowerCase();
    });

    if (!alertBox || !foodSelect) {
        return;
    }

    var FOOD_ALLERGENS = null;

    function setAlert(hits) {
        if (!hits || hits.length === 0) {
            alertBox.classList.add('d-none');
            alertBox.innerHTML = '';
            return;
        }
        alertBox.classList.remove('d-none');

        var badges = hits.map(function(a) {
            return '<span class="badge text-bg-light me-1">' + a + '</span>';
        }).join(' ');

        alertBox.innerHTML =
            '<strong>Warning!</strong> The selected food may contain ' +
            (hits.length === 1 ? 'this allergen' : 'these allergens') +
            badges;
    }

    function checkFood() {
        if (!FOOD_ALLERGENS) return;

        var opt = foodSelect.options[foodSelect.selectedIndex];
        var selectedText = (opt ? opt.text : '').toLowerCase();

        var allergens = (FOOD_ALLERGENS[selectedText] || []).map(function(a) {
            return a.toLowerCase();
        });

        var hits = allergens.filter(function(a) {
            return babyAllergies.indexOf(a) !== -1;
        });

        setAlert(hits);
    }

    fetch(allergenMapUrl, {cache: 'no-store'})
        .then(function(r) { return r.json(); })
        .then(function(json) {
            FOOD_ALLERGENS = {};
            Object.keys(json || {}).forEach(function(key) {
                FOOD_ALLERGENS[key.toLowerCase()] = json[key];
            });
            checkFood();
        })
        .catch(function(err) {
            console.warn('Allergens map load failed', err);
        });

    foodSelect.addEventListener('change', checkFood);
})();
</script>


<!-- Reaction button handling -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    var reactionInput = document.getElementById("{{ entry_form.reaction.id_for_label }}");
    var buttons = document.querySelectorAll(".bb-reaction-btn");

    if (!reactionInput || !buttons.length) {
        return;
    }

    function setActiveButton(value) {
        buttons.forEach(function(btn) {
            if (btn.getAttribute("data-value") === value) {
                btn.classList.add("btn-primary");
                btn.classList.remove("btn-outline-secondary");
            } else {
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-outline-secondary");
            }
        });
    }

    // Initialize from existing value (e.g., when form re-renders with errors)
    if (reactionInput.value) {
        setActiveButton(reactionInput.value);
    }

    buttons.forEach(function(btn) {
        btn.addEventListener("click", function() {
            var val = btn.getAttribute("data-value");

            //enable deselection of reaction choice
            if (reactionInput.value === val) {
                reactionInput.value = "";
                setActiveButton("");
                return;
            }
            
            reactionInput.value = val;
            setActiveButton(val);
        });
    });
});
</script>

{% endblock %}
