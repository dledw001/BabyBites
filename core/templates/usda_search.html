{% extends "base.html" %}
{% load static %}

{% block title %}USDA Food Search{% endblock %}

{% block content %}
<div class="container my-4 text-center">
  <h1 class="bb-title mb-4">
    <span class="top">BabyBites</span>
    <span class="bottom">USDA FOOD SEARCH</span>
  </h1>

  <!-- Search Bar -->
  <form method="get" action="{% url 'usda_search' %}" class="mb-4">
    <div class="input-group justify-content-center" style="max-width: 500px; margin: 0 auto;">
      <input type="text" name="query" value="{{ query }}" class="form-control" placeholder="Search for a food..." required>
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>

  <!-- Error Message -->
  {% if error %}
    <div class="alert alert-danger mt-3">{{ error }}</div>
  {% endif %}

  <!-- USDA Search Results -->
  {% if foods %}
    <div class="mt-4 text-start" style="max-width: 700px; margin: 0 auto;">
      {% for f in foods %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1">{{ f.description }}</h5>
              <p class="text-muted small mb-2">
                <strong>Per 100g:</strong>
                {{ f.calories|floatformat:0 }} kcal |
                P: {{ f.protein|floatformat:1 }}g |
                C: {{ f.carbs|floatformat:1 }}g |
                F: {{ f.fats|floatformat:1 }}g
              </p>
            </div>
          </div>

          <!-- Manual Category Selection Form -->
          <form method="post" action="{% url 'add_usda_food' %}" class="mt-3 d-flex flex-wrap align-items-center justify-content-between">
            {% csrf_token %}
            <!-- Hidden USDA data fields -->
            <input type="hidden" name="name" value="{{ f.description }}">
            <input type="hidden" name="calories_100g" value="{{ f.calories }}">
            <input type="hidden" name="protein_100g" value="{{ f.protein }}">
            <input type="hidden" name="carbs_100g" value="{{ f.carbs }}">
            <input type="hidden" name="fats_100g" value="{{ f.fats }}">
            <input type="hidden" name="fdc_id" value="{{ f.fdcId }}">
            <input type="hidden" name="data_type" value="USDA">

            <!-- Category dropdown -->
            <div class="flex-grow-1 me-2">
              <select name="category_id" class="form-select" required>
                <option value="" disabled selected>Choose Food Pyramid Categoryâ€¦</option>
                {% for c in categories %}
                  <option value="{{ c.id }}">{{ c.name }} (Level {{ c.pyramid_level }})</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <button class="btn btn-success w-100">+ Add to Catalog</button>
            </div>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    {% if query %}
      <p class="text-muted">No results found for <strong>{{ query }}</strong>.</p>
    {% endif %}
  {% endif %}
</div>
{% endblock %}